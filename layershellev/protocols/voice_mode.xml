<?xml version="1.0" encoding="UTF-8"?>
<protocol name="cosmic_voice_mode_v1">
  <copyright>
    Copyright Â© 2026 Playtron

    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
    to deal in the Software without restriction, including without limitation
    the rights to use, copy, modify, merge, publish, distribute, sublicense,
    and/or sell copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice (including the next
    paragraph) shall be included in all copies or substantial portions of the
    Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
    THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
    DEALINGS IN THE SOFTWARE.
  </copyright>

  <description summary="voice mode overlay and input protocol">
    This protocol allows clients to receive voice input events from the compositor.
    The compositor has full control over the voice mode orb overlay - clients
    only receive notifications and voice input events.
    
    Clients register specific surfaces (windows) as voice input receivers.
    When voice mode is activated via hotkey:
    - If a registered surface is focused, it receives start/stop/cancel events
    - If no registered surface is focused, the default receiver (if any) gets events
    
    The orb visual indicator shows where voice input is going:
    - Floating: Default receiver is handling voice input  
    - Attached: A specific window is handling voice input
  </description>

  <interface name="zcosmic_voice_mode_manager_v1" version="1">
    <description summary="manager for voice mode">
      This interface allows clients to register surfaces as voice input receivers.
      The compositor controls voice mode; clients receive events on their surfaces.
    </description>

    <request name="destroy" type="destructor">
      <description summary="destroy the manager">
        Destroy this manager object.
      </description>
    </request>

    <request name="get_voice_mode">
      <description summary="get voice mode controller for a surface">
        Create a voice mode controller for the given wl_surface.
        The surface will receive voice input events when it is focused
        and voice mode is activated.
        
        If is_default is non-zero, this surface becomes the default receiver
        for when no other registered surface is focused. Only one default
        receiver can be active at a time.
      </description>
      <arg name="id" type="new_id" interface="zcosmic_voice_mode_v1"/>
      <arg name="surface" type="object" interface="wl_surface"/>
      <arg name="is_default" type="uint" summary="1 to be default receiver, 0 for window-specific"/>
    </request>
  </interface>

  <interface name="zcosmic_voice_mode_v1" version="1">
    <description summary="voice input receiver for a surface">
      This interface receives voice input events from the compositor
      for a specific surface. Events are sent when:
      - This surface is focused and voice mode activates (window-specific)
      - No registered surface is focused and this is the default receiver
    </description>

    <enum name="orb_state">
      <description summary="orb display states">
        The current display state of the orb.
      </description>
      <entry name="hidden" value="0" summary="orb is not visible"/>
      <entry name="floating" value="1" summary="orb is floating (default receiver active)"/>
      <entry name="attached" value="2" summary="orb is attached to a window"/>
      <entry name="frozen" value="3" summary="orb is frozen in place (processing)"/>
      <entry name="transitioning" value="4" summary="orb is transitioning to attached"/>
    </enum>

    <request name="destroy" type="destructor">
      <description summary="unregister this surface as voice input receiver">
        Destroy this receiver. The surface will no longer receive voice input events.
      </description>
    </request>

    <request name="set_audio_level">
      <description summary="update audio input level for visualization">
        Send the current audio input level for voice orb visualization.
        Clients should call this periodically (e.g., 20-30Hz) while recording
        to provide smooth animation feedback.
        
        The level is a linear amplitude value from 0 to 1000, where:
        - 0 = silence (no audio input)
        - 1000 = maximum amplitude
        
        The compositor uses this to animate the voice orb (pulsing, glow, etc.).
      </description>
      <arg name="level" type="uint" summary="audio level 0-1000 (0=silence, 1000=max)"/>
    </request>

    <request name="ack_stop">
      <description summary="acknowledge will_stop and decide whether to freeze">
        Respond to a will_stop event from the compositor. The client must send
        this within a short time (typically 100ms) after receiving will_stop.
        
        If freeze is non-zero, the orb will freeze in place instead of hiding.
        This is used when transcription is still processing and the client wants
        the orb to remain visible until a new chat window opens.
        
        If freeze is zero, the orb will proceed with the normal hide animation.
        
        If the client doesn't respond in time, the compositor will proceed with
        hiding as a fail-safe.
      </description>
      <arg name="serial" type="uint" summary="serial from the will_stop event"/>
      <arg name="freeze" type="uint" summary="1 to freeze orb, 0 to proceed with hide"/>
    </request>

    <request name="dismiss">
      <description summary="dismiss the frozen orb">
        Request the compositor to hide the voice orb. This is used when
        transcription processing completes but no new window will be opened
        (e.g., empty transcription result or error).
        
        This request is only valid when the orb is in the frozen state
        (after ack_stop with freeze=1). In other states, this request is ignored.
        
        The compositor will animate the orb hiding and clean up voice mode state.
      </description>
    </request>

    <event name="start">
      <description summary="voice input started">
        Sent when voice input has started and this surface should begin
        listening/recording. The client should start capturing audio.
      </description>
      <arg name="orb_state" type="uint" enum="orb_state" summary="where the orb is displayed"/>
    </event>

    <event name="stop">
      <description summary="voice input stopped">
        Sent when voice input has stopped normally (key released).
        The client should stop recording and process the audio.
      </description>
    </event>

    <event name="cancel">
      <description summary="voice input cancelled">
        Sent when voice input was cancelled (e.g., user switched focus,
        pressed escape, or another interruption). The client should
        discard any recorded audio.
      </description>
    </event>

    <event name="orb_attached">
      <description summary="orb attached to this surface">
        Sent when the orb has visually attached to this surface.
        Includes the surface geometry for reference.
      </description>
      <arg name="x" type="int" summary="surface x position"/>
      <arg name="y" type="int" summary="surface y position"/>
      <arg name="width" type="int" summary="surface width"/>
      <arg name="height" type="int" summary="surface height"/>
    </event>

    <event name="orb_detached">
      <description summary="orb detached from this surface">
        Sent when the orb has detached from this surface
        (e.g., focus changed to another surface or default).
      </description>
    </event>

    <event name="will_stop">
      <description summary="voice input is about to stop">
        Sent when voice input is about to stop (user released the hotkey).
        The client must respond with ack_stop to indicate whether to freeze
        the orb or proceed with hiding.
        
        This allows the client to keep the orb visible if transcription is
        still processing and a new window will open soon.
        
        The serial must be echoed back in the ack_stop request.
      </description>
      <arg name="serial" type="uint" summary="serial for ack_stop"/>
    </event>
  </interface>
</protocol>
